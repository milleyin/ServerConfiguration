#!/usr/bin/env bash
set -e

######################################
# SafetyCheck
# Version: v1.1.2
######################################

# ===== 基础路径 =====
BASE_DIR="$HOME/safetyCheck"
BASELINE_DIR="$BASE_DIR/baseline"
LOG_DIR="$BASE_DIR/logs"
VERSION="v1.1.2"

NOW=$(date +"%Y-%m-%d %H:%M:%S")
TS=$(date +"%Y-%m-%d_%H-%M-%S")
LOG_FILE="$LOG_DIR/$TS.log"

mkdir -p "$BASELINE_DIR" "$LOG_DIR"

# ===== 临时目录（避免 /tmp 文件互相踩）=====
TMP_DIR="/tmp/safetycheck.$$"
mkdir -p "$TMP_DIR"
trap 'rm -rf "$TMP_DIR"' EXIT

# ===== 输出同时写终端 + 日志 =====
exec > >(tee -a "$LOG_FILE") 2>&1

log_only() {
  local title="$1"
  local file="$2"
  {
    echo
    echo "$title"
    if [ -s "$file" ]; then
      cat "$file"
    else
      echo "(no changes)"
    fi
  } >> "$LOG_FILE"
}

log_text_only() {
  local title="$1"
  shift
  {
    echo
    echo "$title"
    printf "%s\n" "$@"
  } >> "$LOG_FILE"
}

echo "=============================="
echo " Safety Check $VERSION"
echo " Time: $NOW"
echo "=============================="

changed=false

########################
# 1. PROCESS CHECK
########################
echo
echo "[PROCESS]"

ps aux --sort=pid > "$TMP_DIR/ps.now"

if [ -f "$BASELINE_DIR/ps.txt" ]; then
  { diff -u "$BASELINE_DIR/ps.txt" "$TMP_DIR/ps.now" || true; } > "$TMP_DIR/ps.diff.full"
  log_only "[PROCESS][FULL DIFF]" "$TMP_DIR/ps.diff.full"

  grep '^+' "$TMP_DIR/ps.diff.full" | grep -v '^+++' > "$TMP_DIR/ps.diff.added" || true

  grep -E '(/tmp|/var/tmp|/dev/shm|/home/|bash -c|sh -c|python -c|perl -e|curl .*bash|wget .*sh|nc |socat )' \
    "$TMP_DIR/ps.diff.added" > "$TMP_DIR/ps.diff.risky" || true

  if [ -s "$TMP_DIR/ps.diff.risky" ]; then
    echo "⚠️  Suspicious process detected:"
    sed 's/^/  /' "$TMP_DIR/ps.diff.risky"
    changed=true
  else
    echo "✅ OK"
  fi
else
  echo "Baseline not found, creating..."
  log_text_only "[PROCESS][NOTE]" \
    "Baseline not found, creating..." \
    "Baseline created at $NOW by $(whoami) on $(hostname)"
fi

cp "$TMP_DIR/ps.now" "$BASELINE_DIR/ps.txt"

######################################
# 2. NETWORK (ESTABLISHED)
######################################
echo
echo "[NETWORK]"

# 只保留稳定字段，避免 Recv-Q / Send-Q 抖动
ss -H -antp state established \
  | awk '{print $1, $2, $4, $5, $6}' \
  | sort > "$TMP_DIR/net.now"

if [ -f "$BASELINE_DIR/net.txt" ]; then
  # 1️⃣ 全量 diff → 写 log
  { diff -u "$BASELINE_DIR/net.txt" "$TMP_DIR/net.now" || true; } > "$TMP_DIR/net.diff.full"
  log_only "[NETWORK][FULL DIFF]" "$TMP_DIR/net.diff.full"

  # 2️⃣ 只取新增连接
  grep '^+' "$TMP_DIR/net.diff.full" \
    | grep -v '^+++' \
    > "$TMP_DIR/net.diff.added" || true

  # 3️⃣ 风险判定：
  #    - 排除 sshd（自己登录）
  #    - 排除 nginx（Web 流量天然噪音）
  grep -Ev 'sshd|nginx' "$TMP_DIR/net.diff.added" > "$TMP_DIR/net.diff.risky" || true

  if [ -s "$TMP_DIR/net.diff.risky" ]; then
    echo "⚠️  Suspicious network connections:"
    sed 's/^/  /' "$TMP_DIR/net.diff.risky"
    changed=true
  else
    echo "✅ OK"
  fi
else
  echo "Baseline not found, creating..."
  log_text_only "[NETWORK][NOTE]" "Baseline not found, creating..."
fi

cp "$TMP_DIR/net.now" "$BASELINE_DIR/net.txt"

######################################
# 3. LISTEN PORTS
######################################
echo
echo "[LISTEN PORTS]"

ss -H -lntup \
  | awk '{print $1, $2, $5, $6}' \
  | sort > "$TMP_DIR/listen.now"

if [ -f "$BASELINE_DIR/listen.txt" ]; then
  { diff -u "$BASELINE_DIR/listen.txt" "$TMP_DIR/listen.now" || true; } > "$TMP_DIR/listen.diff.full"
  log_only "[LISTEN PORTS][FULL DIFF]" "$TMP_DIR/listen.diff.full"

  grep '^+' "$TMP_DIR/listen.diff.full" | grep -v '^+++' > "$TMP_DIR/listen.diff.added" || true

  if [ -s "$TMP_DIR/listen.diff.added" ]; then
    echo "⚠️  New listening ports detected:"
    sed 's/^/  /' "$TMP_DIR/listen.diff.added"
    changed=true
  else
    echo "✅ OK"
  fi
else
  echo "Baseline not found, creating..."
  log_text_only "[LISTEN PORTS][NOTE]" "Baseline not found, creating..."
fi

cp "$TMP_DIR/listen.now" "$BASELINE_DIR/listen.txt"

######################################
# 4. CRON (HIGH RISK)
######################################
echo
echo "[CRON]"

{
  echo "## crontab -l"
  crontab -l 2>/dev/null || true
  echo
  echo "## /etc/cron.*"
  ls -l /etc/cron.* 2>/dev/null || true
} > "$TMP_DIR/cron.now"

if [ -f "$BASELINE_DIR/cron.txt" ]; then
  { diff -u "$BASELINE_DIR/cron.txt" "$TMP_DIR/cron.now" || true; } > "$TMP_DIR/cron.diff.full"
  log_only "[CRON][FULL DIFF]" "$TMP_DIR/cron.diff.full"

  if [ -s "$TMP_DIR/cron.diff.full" ]; then
    echo "❗ HIGH RISK: Cron changed"
    grep -E '^[\+\-]' "$TMP_DIR/cron.diff.full" | grep -vE '^\+\+\+|^\-\-\-' | sed 's/^/  /' || true
    changed=true
  else
    echo "✅ OK"
  fi
else
  echo "Baseline not found, creating..."
  log_text_only "[CRON][NOTE]" "Baseline not found, creating..."
fi

cp "$TMP_DIR/cron.now" "$BASELINE_DIR/cron.txt"

######################################
# 5. USER & PERMISSION (HIGH RISK)
######################################
echo
echo "[USER & PERMISSION]"

{
  echo "## getent passwd"
  getent passwd || true
  echo
  echo "## getent group"
  getent group || true
  echo
  echo "## sudoers.d (ls -l)"
  ls -l /etc/sudoers.d 2>/dev/null || true
  echo
  echo "## /etc/sudoers (if readable)"
  cat /etc/sudoers 2>/dev/null || true
  echo
  echo "## /etc/sudoers.d/* (if readable)"
  cat /etc/sudoers.d/* 2>/dev/null || true
} > "$TMP_DIR/userperm.now"

if [ -f "$BASELINE_DIR/userperm.txt" ]; then
  { diff -u "$BASELINE_DIR/userperm.txt" "$TMP_DIR/userperm.now" || true; } > "$TMP_DIR/userperm.diff.full"
  log_only "[USER & PERMISSION][FULL DIFF]" "$TMP_DIR/userperm.diff.full"

  if [ -s "$TMP_DIR/userperm.diff.full" ]; then
    echo "❗ HIGH RISK: User / group / sudo privilege changed"
    grep -E '^[\+\-]' "$TMP_DIR/userperm.diff.full" | grep -vE '^\+\+\+|^\-\-\-' | sed 's/^/  /' || true
    changed=true
  else
    echo "✅ OK"
  fi
else
  echo "Baseline not found, creating..."
  log_text_only "[USER & PERMISSION][NOTE]" "Baseline not found, creating..."
fi

cp "$TMP_DIR/userperm.now" "$BASELINE_DIR/userperm.txt"

######################################
# 6. SSH AUTHORIZED KEYS (HIGH RISK)
######################################
echo
echo "[SSH AUTH KEYS]"

{
  find /root /home -type f -path "*/.ssh/authorized_keys" 2>/dev/null \
    | sort \
    | while read -r f; do
        echo "### $f"
        stat -c "perm=%a owner=%U group=%G size=%s mtime=%y" "$f" 2>/dev/null || true
        echo "---BEGIN---"
        cat "$f" 2>/dev/null || true
        echo "---END---"
        echo
      done
} > "$TMP_DIR/sshkeys.now"

if [ -f "$BASELINE_DIR/sshkeys.txt" ]; then
  { diff -u "$BASELINE_DIR/sshkeys.txt" "$TMP_DIR/sshkeys.now" || true; } > "$TMP_DIR/sshkeys.diff.full"
  log_only "[SSH AUTH KEYS][FULL DIFF]" "$TMP_DIR/sshkeys.diff.full"

  if [ -s "$TMP_DIR/sshkeys.diff.full" ]; then
    echo "❗ HIGH RISK: SSH authorized_keys changed"
    grep -E '^[\+\-].*(ssh-|ecdsa-|sk-ssh-)' "$TMP_DIR/sshkeys.diff.full" | sed 's/^/  /' || true
    changed=true
  else
    echo "✅ OK"
  fi
else
  echo "Baseline not found, creating..."
  log_text_only "[SSH AUTH KEYS][NOTE]" "Baseline not found, creating..."
fi

cp "$TMP_DIR/sshkeys.now" "$BASELINE_DIR/sshkeys.txt"

######################################
# 7. SYSTEMD ENABLED SERVICES (HIGH RISK)
######################################
echo
echo "[SYSTEMD SERVICES]"

systemctl list-unit-files --state=enabled --no-pager 2>/dev/null | sort > "$TMP_DIR/systemd.now" || true

if [ -f "$BASELINE_DIR/systemd.txt" ]; then
  { diff -u "$BASELINE_DIR/systemd.txt" "$TMP_DIR/systemd.now" || true; } > "$TMP_DIR/systemd.diff.full"
  log_only "[SYSTEMD SERVICES][FULL DIFF]" "$TMP_DIR/systemd.diff.full"

  grep '^+' "$TMP_DIR/systemd.diff.full" | grep -v '^+++' > "$TMP_DIR/systemd.diff.added" || true

  if [ -s "$TMP_DIR/systemd.diff.added" ]; then
    echo "❗ HIGH RISK: New enabled service detected"
    sed 's/^/  /' "$TMP_DIR/systemd.diff.added"
    changed=true
  else
    echo "✅ OK"
  fi
else
  echo "Baseline not found, creating..."
  log_text_only "[SYSTEMD SERVICES][NOTE]" "Baseline not found, creating..."
fi

cp "$TMP_DIR/systemd.now" "$BASELINE_DIR/systemd.txt"

######################################
# 8. FIREWALL (iptables) (HIGH RISK)
######################################
echo
echo "[FIREWALL]"

if command -v iptables-save >/dev/null 2>&1; then
  iptables-save 2>/dev/null \
    | grep -vE '^# (Generated|Completed) ' \
    > "$TMP_DIR/iptables.now" || true
else
  cat /etc/sysconfig/iptables 2>/dev/null \
    | grep -vE '^# (Generated|Completed) ' \
    > "$TMP_DIR/iptables.now" || true
fi

if [ -f "$BASELINE_DIR/iptables.txt" ]; then
  { diff -u "$BASELINE_DIR/iptables.txt" "$TMP_DIR/iptables.now" || true; } > "$TMP_DIR/iptables.diff.full"
  log_only "[FIREWALL][FULL DIFF]" "$TMP_DIR/iptables.diff.full"

  if [ -s "$TMP_DIR/iptables.diff.full" ]; then
    echo "❗ HIGH RISK: Firewall rules changed"
    grep -E '^[\+\-]' "$TMP_DIR/iptables.diff.full" | grep -vE '^\+\+\+|^\-\-\-' | sed 's/^/  /' || true
    changed=true
  else
    echo "✅ OK"
  fi
else
  echo "Baseline not found, creating..."
  log_text_only "[FIREWALL][NOTE]" "Baseline not found, creating..."
fi

cp "$TMP_DIR/iptables.now" "$BASELINE_DIR/iptables.txt"

######################################
# 9. LOGIN ACTIVITY (LOG ONLY)
######################################
echo
echo "[LOGIN ACTIVITY]"
{
  echo
  echo "[LOGIN ACTIVITY][LAST 50]"
  last -a 2>/dev/null | head -50 || true
} >> "$LOG_FILE"
echo "✅ Logged (informational)"

######################################
# SUMMARY
######################################
echo
echo "=============================="
if [ "$changed" = true ]; then
  echo "RESULT: ⚠️  ATTENTION REQUIRED"
else
  echo "RESULT: ✅ ALL CHECKS PASSED"
fi
echo "Log saved to: $LOG_FILE"
echo "=============================="