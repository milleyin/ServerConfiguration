#!/usr/bin/env bash
set -e

# ===== 基础路径 =====
BASE_DIR="$HOME/safetyCheck"
BASELINE_DIR="$BASE_DIR/baseline"
LOG_DIR="$BASE_DIR/logs"
NOW=$(date +"%Y-%m-%d %H:%M:%S")
LOG_FILE="$LOG_DIR/$(date +"%Y-%m-%d_%H-%M-%S").log"

mkdir -p "$BASELINE_DIR" "$LOG_DIR"

# ===== 输出同时写终端 + 日志 =====
exec > >(tee -a "$LOG_FILE") 2>&1

echo "=============================="
echo " Security Check @ $NOW"
echo "=============================="

changed=false

########################
# 1. PROCESS CHECK
########################
echo
echo "[PROCESS]"

ps aux --sort=pid > /tmp/ps.now

if [ -f "$BASELINE_DIR/ps.txt" ]; then
  diff -u "$BASELINE_DIR/ps.txt" /tmp/ps.now || true > /tmp/ps.diff.full

  # 只挑可能有风险的进程变化
  grep -E '^\+.*(/tmp|/var/tmp|/dev/shm|/home|bash|sh )' /tmp/ps.diff.full > /tmp/ps.diff.risky || true

  if [ -s /tmp/ps.diff.risky ]; then
    echo "⚠️  Suspicious process changes:"
    sed 's/^/  /' /tmp/ps.diff.risky
    changed=true
  else
    echo "✓ No suspicious process change"
  fi
else
  echo "Baseline not found, creating..."
fi

cp /tmp/ps.now "$BASELINE_DIR/ps.txt"

########################
# 2. NETWORK CHECK
########################
echo
echo "[NETWORK]"

ss -antp | grep ESTAB | sort > /tmp/net.now

if [ -f "$BASELINE_DIR/net.txt" ]; then
  diff -u "$BASELINE_DIR/net.txt" /tmp/net.now || true > /tmp/net.diff.full

  # 排除 SSH 自己的连接，只看异常服务端口
  grep -Ev 'sshd' /tmp/net.diff.full > /tmp/net.diff.risky || true

  if [ -s /tmp/net.diff.risky ]; then
    echo "⚠️  Suspicious network connections:"
    sed 's/^/  /' /tmp/net.diff.risky
    changed=true
  else
    echo "✓ No suspicious network connections"
  fi
else
  echo "Baseline not found, creating..."
fi

cp /tmp/net.now "$BASELINE_DIR/net.txt"

########################
# 3. CRON CHECK（高风险）
########################
echo
echo "[CRON]"

{
  crontab -l 2>/dev/null || true
  ls -l /etc/cron.* 2>/dev/null || true
} > /tmp/cron.now

if [ -f "$BASELINE_DIR/cron.txt" ]; then
  diff -u "$BASELINE_DIR/cron.txt" /tmp/cron.now || true > /tmp/cron.diff

  if [ -s /tmp/cron.diff ]; then
    echo "❗ Cron changed (high risk):"
    sed 's/^/  /' /tmp/cron.diff
    changed=true
  else
    echo "✓ No cron change"
  fi
else
  echo "Baseline not found, creating..."
fi

cp /tmp/cron.now "$BASELINE_DIR/cron.txt"

########################
# 4. FILE CHANGE CHECK
########################
echo
echo "[FILES]"

find / -xdev -type f -mtime -3 \
  ! -path "/proc/*" \
  ! -path "/sys/*" \
  ! -path "/run/*" \
  ! -path "/tmp/*" \
  ! -path "/var/tmp/*" \
  ! -path "/var/log/*" \
  ! -path "$BASE_DIR/*" \
  | sort > /tmp/files.now

if [ -f "$BASELINE_DIR/files.txt" ]; then
  diff -u "$BASELINE_DIR/files.txt" /tmp/files.now || true > /tmp/files.diff.full

  # 只提示非系统目录的新增文件
  grep -E '^\+.*(/home|/root|/opt|/usr/local)' /tmp/files.diff.full > /tmp/files.diff.risky || true

  if [ -s /tmp/files.diff.risky ]; then
    echo "⚠️  Suspicious file changes:"
    sed 's/^/  /' /tmp/files.diff.risky
    changed=true
  else
    echo "✓ No suspicious file change"
  fi
else
  echo "Baseline not found, creating..."
fi

cp /tmp/files.now "$BASELINE_DIR/files.txt"

########################
# SUMMARY
########################
echo
echo "=============================="
if [ "$changed" = true ]; then
  echo "RESULT: ⚠️  CHANGES DETECTED — manual review recommended"
else
  echo "RESULT: ✅ OK — no unexpected changes"
fi
echo "Log saved to: $LOG_FILE"
echo "=============================="