#!/usr/bin/env bash
set -e

### ===== 基础路径 =====
SAFETY_DIR="$HOME/safetyCheck"
BASELINE_DIR="$SAFETY_DIR/baseline"
LOG_DIR="$SAFETY_DIR/logs"

mkdir -p "$BASELINE_DIR" "$LOG_DIR"

NOW_TS="$(date '+%Y-%m-%d %H:%M:%S')"
LOG_FILE="$LOG_DIR/$(date '+%Y-%m-%d_%H-%M-%S').log"

# 输出同时写日志
exec > >(tee -a "$LOG_FILE") 2>&1

echo "=============================="
echo " Security Check @ $NOW_TS"
echo "=============================="

changed=false

### ===== 1. 进程检查 =====
echo
echo "[PROCESS]"

ps aux --sort=pid \
  | grep -Ev 'kworker|sshd-session|systemd --user|ps aux|bash' \
  > /tmp/ps.now

if [ -f "$BASELINE_DIR/ps.txt" ]; then
  diff_out=$(diff -u "$BASELINE_DIR/ps.txt" /tmp/ps.now || true)
  if [ -n "$diff_out" ]; then
    echo "⚠️  Process list changed (filtered):"
    echo "$diff_out" | sed 's/^/  /'
    changed=true
  else
    echo "✓ No meaningful process change"
  fi
else
  echo "Baseline not found, creating..."
fi

cp /tmp/ps.now "$BASELINE_DIR/ps.txt"

### ===== 2. 网络连接检查 =====
echo
echo "[NETWORK]"

ss -antp \
  | grep ESTAB \
  | grep -Ev ':(22|80|443|3306)\s' \
  | sort > /tmp/net.now

if [ -f "$BASELINE_DIR/net.txt" ]; then
  diff_out=$(diff -u "$BASELINE_DIR/net.txt" /tmp/net.now || true)
  if [ -n "$diff_out" ]; then
    echo "⚠️  Suspicious ESTABLISHED connections:"
    echo "$diff_out" | sed 's/^/  /'
    changed=true
  else
    echo "✓ No suspicious network connections"
  fi
else
  echo "Baseline not found, creating..."
fi

cp /tmp/net.now "$BASELINE_DIR/net.txt"

### ===== 3. Cron 检查（高风险项）=====
echo
echo "[CRON]"

{
  crontab -l 2>/dev/null || true
  ls -l /etc/cron.* 2>/dev/null || true
} > /tmp/cron.now

if [ -f "$BASELINE_DIR/cron.txt" ]; then
  diff_out=$(diff -u "$BASELINE_DIR/cron.txt" /tmp/cron.now || true)
  if [ -n "$diff_out" ]; then
    echo "❗ CRON CHANGED (HIGH RISK):"
    echo "$diff_out" | sed 's/^/  /'
    changed=true
  else
    echo "✓ No cron change"
  fi
else
  echo "Baseline not found, creating..."
fi

cp /tmp/cron.now "$BASELINE_DIR/cron.txt"

### ===== 4. 文件变动检查 =====
echo
echo "[FILES]"

find / -xdev -type f -mtime -3 \
  ! -path "/proc/*" \
  ! -path "/sys/*" \
  ! -path "/run/*" \
  ! -path "/tmp/*" \
  ! -path "/var/tmp/*" \
  ! -path "/var/log/*" \
  | sort > /tmp/files.now

if [ -f "$BASELINE_DIR/files.txt" ]; then
  diff_out=$(diff -u "$BASELINE_DIR/files.txt" /tmp/files.now || true)
  if [ -n "$diff_out" ]; then
    echo "⚠️  File changes detected (filtered):"
    echo "$diff_out" | sed 's/^/  /'
    changed=true
  else
    echo "✓ No suspicious file changes"
  fi
else
  echo "Baseline not found, creating..."
fi

cp /tmp/files.now "$BASELINE_DIR/files.txt"

### ===== 总结 =====
echo
echo "=============================="
if [ "$changed" = true ]; then
  echo "RESULT: ⚠️  CHANGES DETECTED — manual review recommended"
else
  echo "RESULT: ✅ OK — no unexpected changes"
fi
echo "Log saved to: $LOG_FILE"
echo "=============================="